[{"name":"app.R","content":"# ========================================================================\r\n# APLICAÇÃO SHINY PARA PROCESSAMENTO DE PDF DE PESQUISA DE PREÇO\r\n# VERSÃO COMPLETA E ATUALIZADA\r\n# ========================================================================\r\n\r\n# --- 1. Carregar Todas as Bibliotecas Necessárias ---\r\nlibrary(shiny)\r\nlibrary(stringr)\r\nlibrary(dplyr)\r\nlibrary(tidyr)\r\nlibrary(openxlsx)\r\nlibrary(bslib)\r\nlibrary(base64enc)\r\n\r\n# --- AUMENTAR LIMITE DE UPLOAD PARA 100MB ---\r\noptions(shiny.maxRequestSize = 100 * 1024^2)\r\n\r\n# =============================================================================\r\n# FUNÇÕES GLOBAIS E DE UTILIDADE\r\n# =============================================================================\r\n\r\n# --- FUNÇÃO HELPER PARA CONVERTER NÚMEROS NO FORMATO BRASILEIRO ---\r\nparse_br_number <- function(s) {\r\n  s <- as.character(s)\r\n  s_cleaned <- str_remove_all(s, \"[R$\\\\s]\") %>%\r\n    str_replace_all(\"\\\\.\", \"\") %>%\r\n    str_replace(\",\", \".\")\r\n  return(as.numeric(s_cleaned))\r\n}\r\n\r\n# --- OBTÉM TEXTO DAS PÁGINAS DO PDF ---\r\nget_pdf_text_pages <- function(local_path, webr_pages) {\r\n  if (!is.null(webr_pages) && length(webr_pages) > 0) {\r\n    return(webr_pages)\r\n  }\r\n  if (requireNamespace(\"pdftools\", quietly = TRUE)) {\r\n    return(pdftools::pdf_text(local_path))\r\n  }\r\n  stop(\"Nenhum mecanismo de leitura de PDF disponível.\")\r\n}\r\n\r\n# ===================================================================================\r\n# LÓGICA DE EXTRAÇÃO DE DADOS (BACK-END)\r\n# ===================================================================================\r\n\r\nextract_format_AB <- function(all_lines, state_vars) {\r\n  all_quotes_list <- list()\r\n  main_line_regex <- \"(R\\\\$\\\\s*[\\\\d.,]+)\\\\s+([0-9]{2}/[0-9]{2}/[0-9]{4})\\\\s+(Sim|Não)\\\\s*$\"\r\n  \r\n  for (i in seq_along(all_lines)) {\r\n    line <- all_lines[i]\r\n    if (str_detect(line, main_line_regex)) {\r\n      main_match <- str_match(line, main_line_regex)\r\n      preco_unitario_str <- str_remove_all(main_match[1, 2], \"[R$\\\\s]\")\r\n      data_cotacao <- main_match[1, 3]\r\n      compone <- main_match[1, 4]\r\n      processed_line <- str_remove(line, main_line_regex)\r\n      start_match <- str_match(processed_line, \"^\\\\s*(\\\\S+)\\\\s+([IVXLCDM]+)\")\r\n      if (is.na(start_match[1, 1])) next\r\n      n_cotacao <- start_match[1, 2]\r\n      inciso_val <- start_match[1, 3]\r\n      middle_block <- str_trim(str_remove(processed_line, \"^\\\\s*\\\\S+\\\\s+[IVXLCDM]+\"))\r\n      qty_unit_match <- str_match(middle_block, \"^(.*?)\\\\s+([\\\\d.,]+)\\\\s+(.*)$\")\r\n      nome_na_linha <- \"\"\r\n      quantidade <- \"1\"\r\n      unidade <- \"Unidade\"\r\n      if (!is.na(qty_unit_match[1, 1])) {\r\n        nome_na_linha <- str_trim(qty_unit_match[1, 2])\r\n        quantidade <- qty_unit_match[1, 3]\r\n        unidade <- str_trim(qty_unit_match[1, 4])\r\n      } else {\r\n        nome_na_linha <- middle_block\r\n      }\r\n      nome_partes_superiores <- c()\r\n      for (j in (i - 1):max(1, i - 4)) {\r\n        if (str_detect(all_lines[j], \"Nº\\\\s+Inciso\\\\s+Nome\")) break\r\n        nome_partes_superiores <- c(str_squish(all_lines[j]), nome_partes_superiores)\r\n      }\r\n      nome_completo <- str_squish(paste(paste(nome_partes_superiores, collapse=\" \"), nome_na_linha, collapse=\" \"))\r\n      if (nchar(nome_completo) > 0 && !str_detect(nome_completo, \"Compras\\\\.gov\\\\.br\")) {\r\n        nome_completo <- paste(nome_completo, \"- Compras.gov.br\")\r\n      }\r\n      nome_completo <- str_remove(nome_completo, \"^-\") %>% str_squish()\r\n      \r\n      preco_numerico <- parse_br_number(preco_unitario_str)\r\n      preco_formatado <- if (!is.na(preco_numerico)) {\r\n        str_replace(sprintf(\"%.4f\", preco_numerico), \"\\\\.\", \",\")\r\n      } else {\r\n        preco_unitario_str\r\n      }\r\n      \r\n      endereco_eletronico <- NA_character_\r\n      anexo <- NA_character_\r\n      search_window_start <- i + 1\r\n      search_window_end <- min(i + 15, length(all_lines))\r\n      if (search_window_start <= search_window_end) {\r\n        search_block <- paste(all_lines[search_window_start:search_window_end], collapse = \" \\n \")\r\n        anexo_match <- str_match(search_block, \"(ITEM\\\\s+\\\\d+[\\\\s\\\\d]*\\\\.pdf)\")\r\n        if (!is.na(anexo_match[1, 1])) {\r\n          anexo <- str_squish(anexo_match[1, 1])\r\n        }\r\n        if (str_detect(search_block, \"https?://\")) {\r\n          url_block <- search_block\r\n          if (!is.na(anexo)) {\r\n            url_block <- str_remove(url_block, fixed(anexo))\r\n          }\r\n          url_block <- str_split(url_block, \"Nº\\\\s+Inciso\\\\s+Nome|Legenda:|Cotação de preços para o item\")[[1]][1]\r\n          url_block <- str_remove_all(url_block, \"\\\\d{2}:\\\\d{2}\")\r\n          url_block <- str_remove_all(url_block, \"Endereço Eletrônico|Anexos|Hora da Cotação|Data da Cotação|Marca/Modelo|Informações Adicionais\")\r\n          url_match <- str_match(url_block, \"(https?://[\\\\s\\\\S]*)\")\r\n          if(!is.na(url_match[1,2])){\r\n            potential_url <- url_match[1,2]\r\n            endereco_eletronico <- str_replace_all(potential_url, \"\\\\s+\", \"\") %>% str_extract(\"https?://[^\\\\s]+\")\r\n          }\r\n        }\r\n      }\r\n      \r\n      all_quotes_list[[length(all_quotes_list) + 1]] <- tibble::tibble(\r\n        `Número da Pesquisa` = state_vars$numero_pesquisa, UASG = state_vars$uasg, `Título da Pesquisa` = state_vars$titulo,\r\n        Item = state_vars$item_num, CATMAT = state_vars$catmat, `Descrição do Item` = state_vars$item_desc,\r\n        `Nº Cotação` = n_cotacao, Inciso = inciso_val, Nome = nome_completo, Quantidade = quantidade, Unidade = unidade,\r\n        `Preço unitário` = preco_formatado, Data = data_cotacao, Compõe = compone,\r\n        `Endereço Eletrônico` = endereco_eletronico, Anexo = anexo\r\n      )\r\n    }\r\n  }\r\n  return(all_quotes_list)\r\n}\r\n\r\nextract_format_C <- function(all_lines, state_vars) {\r\n  all_quotes_list <- list()\r\n  for (i in seq_along(all_lines)) {\r\n    line <- all_lines[i]\r\n    if (str_detect(line, \"Cotação de preços para o item\")) {\r\n      fornecedor <- str_match(line, \"Fornecedor: (.*?) - CNPJ:\")[,2]\r\n      linha_inciso <- \"\"\r\n      linha_financeira <- \"\"\r\n      for (j in (i + 1):min(i + 10, length(all_lines))) {\r\n        if (str_detect(all_lines[j], \"^\\\\s*\\\\d+\\\\s+[IVXLCDM]+\")) linha_inciso <- all_lines[j]\r\n        if (str_detect(all_lines[j], \"R\\\\$\")) {\r\n          linha_financeira <- all_lines[j]\r\n          break\r\n        }\r\n      }\r\n      if (nchar(linha_inciso) > 0 && nchar(linha_financeira) > 0) {\r\n        n_cotacao <- str_match(linha_inciso, \"^\\\\s*(\\\\d+)\")[,2]\r\n        inciso <- str_match(linha_inciso, \"^\\\\s*\\\\d+\\\\s+([IVXLCDM]+)\")[,2]\r\n        tokens_financeiro <- str_squish(linha_financeira) %>% str_split(\"\\\\s+\") %>% .[[1]]\r\n        quantidade <- tokens_financeiro[1]\r\n        preco_unitario_str <- str_remove(tokens_financeiro[2], \"R\\\\$\")\r\n        data_cotacao <- tokens_financeiro[3]\r\n        compone <- tokens_financeiro[4]\r\n        \r\n        preco_numerico <- parse_br_number(preco_unitario_str)\r\n        preco_formatado <- if (!is.na(preco_numerico)) {\r\n          str_replace(sprintf(\"%.4f\", preco_numerico), \"\\\\.\", \",\")\r\n        } else {\r\n          preco_unitario_str\r\n        }\r\n        \r\n        all_quotes_list[[length(all_quotes_list) + 1]] <- tibble::tibble(\r\n          `Número da Pesquisa`=state_vars$numero_pesquisa, UASG=state_vars$uasg, `Título da Pesquisa`=state_vars$titulo,\r\n          Item=state_vars$item_num, CATMAT=state_vars$catmat, `Descrição do Item`=state_vars$item_desc,\r\n          `Nº Cotação`=n_cotacao, Inciso=inciso, Nome=fornecedor, Quantidade=quantidade, Unidade=\"N/I\",\r\n          `Preço unitário`=preco_formatado, Data=data_cotacao, Compõe=compone,\r\n          `Endereço Eletrônico` = NA_character_, Anexo = NA_character_\r\n        )\r\n      }\r\n    }\r\n  }\r\n  return(all_quotes_list)\r\n}\r\n\r\nextract_price_data_from_pages <- function(text_from_pages) {\r\n  full_text <- paste(text_from_pages, collapse = \"\\n\")\r\n  all_lines <- unlist(str_split(full_text, \"\\n\"))\r\n  state_vars <- list(numero_pesquisa=NA, uasg=NA, titulo=NA, item_num=NA, catmat=NA, item_desc=NA)\r\n  final_results <- list()\r\n  pesquisa_starts <- which(str_detect(all_lines, \"Relatório de pesquisa de preço\"))\r\n  pesquisa_starts <- c(pesquisa_starts, length(all_lines) + 1)\r\n  for (p in 1:(length(pesquisa_starts) - 1)) {\r\n    start_line <- pesquisa_starts[p]\r\n    end_line <- pesquisa_starts[p+1] - 1\r\n    pesquisa_lines <- all_lines[start_line:end_line]\r\n    header_idx <- which(str_detect(pesquisa_lines, \"Número da Pesquisa\\\\s+UASG\"))\r\n    if(length(header_idx) > 0) {\r\n      data_line <- pesquisa_lines[header_idx[1] + 1]\r\n      parts <- str_squish(data_line) %>% str_split(\"\\\\s+\") %>% .[[1]]\r\n      if(length(parts) >= 2) { state_vars$numero_pesquisa <- parts[1]; state_vars$uasg <- parts[2] }\r\n    }\r\n    titulo_idx <- which(str_detect(pesquisa_lines, \"^\\\\s*Título:\"))\r\n    if(length(titulo_idx) > 0) { state_vars$titulo <- str_remove(pesquisa_lines[titulo_idx[1]], \"Título:\") %>% str_squish() }\r\n    item_starts <- which(str_detect(pesquisa_lines, \"^\\\\s*Item:\\\\s*\\\\d+\"))\r\n    item_starts <- c(item_starts, length(pesquisa_lines) + 1)\r\n    for (k in 1:(length(item_starts) - 1)) {\r\n      item_start_line <- item_starts[k]\r\n      item_end_line <- item_starts[k+1] - 1\r\n      item_lines <- pesquisa_lines[item_start_line:item_end_line]\r\n      state_vars$item_num <- str_extract(item_lines[1], \"\\\\d+\")\r\n      desc_start_idx <- which(str_detect(item_lines, \"Descrição do item\"))\r\n      desc_end_idx <- which(str_detect(item_lines, \"Consolidação dos preços cotados\"))\r\n      if (length(desc_start_idx) > 0 && length(desc_end_idx) > 0) {\r\n        full_desc <- paste(item_lines[(desc_start_idx[1]+1):(desc_end_idx[1]-1)], collapse=\" \") %>% str_squish()\r\n        desc_matches <- str_match(full_desc, \"^(\\\\d+)\\\\s*-\\\\s*(.*)\")\r\n        if(!is.na(desc_matches[1,1])) { state_vars$catmat <- desc_matches[1,2]; state_vars$item_desc <- desc_matches[1,3] }\r\n        else { state_vars$catmat <- \"N/A\"; state_vars$item_desc <- full_desc }\r\n      }\r\n      item_text <- paste(item_lines, collapse=\"\\n\")\r\n      if (str_detect(item_text, \"Cotação de preços para o item\")) {\r\n        final_results <- c(final_results, extract_format_C(item_lines, state_vars))\r\n      } else {\r\n        final_results <- c(final_results, extract_format_AB(item_lines, state_vars))\r\n      }\r\n    }\r\n  }\r\n  if (length(final_results) > 0) return(dplyr::distinct(dplyr::bind_rows(final_results)))\r\n  else return(data.frame())\r\n}\r\n\r\nextract_all_pdf_medians_from_pages <- function(pdf_pages_vec) {\r\n  full_pdf_text <- paste(pdf_pages_vec, collapse = \"\\n\\n\")\r\n  pesquisa_blocks <- str_split(full_pdf_text, \"Relatório de pesquisa de preço\")[[1]][-1]\r\n  all_medians_list <- list()\r\n  for(pesquisa_block in pesquisa_blocks) {\r\n    numero_pesquisa_match <- str_match(pesquisa_block, \"Número da Pesquisa\\\\s+UASG\\\\s+Status\\\\s+Editado por\\\\s*([\\\\d/]+)\")\r\n    numero_pesquisa <- if (!is.na(numero_pesquisa_match[1, 2])) str_squish(numero_pesquisa_match[1, 2]) else NA_character_\r\n    item_blocks <- str_split(pesquisa_block, \"Item:\\\\s*\")[[1]][-1]\r\n    if (length(item_blocks) < 1) next\r\n    for (block in item_blocks) {\r\n      item_number <- as.integer(str_extract(block, \"^\\\\d+\"))\r\n      if (is.na(item_number)) next\r\n      median_value <- NA_real_\r\n      block_lines <- str_split(block, \"\\n\")[[1]]\r\n      header_line_idx <- which(str_detect(block_lines, \"Menor Preço.*Média.*Mediana\"))\r\n      if (length(header_line_idx) > 0) {\r\n        search_window <- block_lines[(header_line_idx[1] + 1):min(header_line_idx[1] + 5, length(block_lines))]\r\n        for (line in search_window) {\r\n          if (str_count(line, \"R\\\\$\") >= 3) {\r\n            price_values <- str_extract_all(line, \"R\\\\$\\\\s*[\\\\d.,]+\")[[1]]\r\n            if (length(price_values) >= 3) {\r\n              median_value <- parse_br_number(price_values[3])\r\n              break\r\n            }\r\n          }\r\n        }\r\n      }\r\n      all_medians_list[[length(all_medians_list) + 1]] <- tibble::tibble(\r\n        `Número da Pesquisa` = numero_pesquisa, Item = item_number, \r\n        `MEDIANA (PAINEL DE PREÇOS)` = median_value\r\n      )\r\n    }\r\n  }\r\n  if (length(all_medians_list) > 0) return(bind_rows(all_medians_list))\r\n  else stop(\"ERRO: Nenhuma mediana foi encontrada no documento.\")\r\n}\r\n\r\n# ===================================================================================\r\n# INTERFACE DO USUÁRIO (UI) - FRONT-END\r\n# ===================================================================================\r\nui <- fluidPage(\r\n  theme = bslib::bs_theme(\r\n    version = 5, preset = \"shiny\", bg = \"#F0F3F4\", fg = \"#1C2833\", primary = \"#1E8449\",\r\n    secondary = \"#145A32\", base_font = bslib::font_google(\"Montserrat\", local = FALSE),\r\n    heading_font = bslib::font_google(\"Roboto Slab\", local = FALSE),\r\n    \"card-header-bg\" = \"#1E8449\", \"card-header-color\" = \"#FFFFFF\"\r\n  ),\r\n  tags$head(\r\n    tags$style(HTML(\"\r\n      #status_text { \r\n        color: white; \r\n        background-color: transparent; \r\n        border: none;\r\n        white-space: pre-wrap;\r\n        word-break: break-all;\r\n      }\r\n      .faded-text {\r\n        color: #AAB7B8;\r\n      }\r\n      #pdf_file_progress .progress { height: 2.8em; font-size: 1.3em; border-radius: 5px; }\r\n      #pdf_file_progress .progress-bar { line-height: 2.8em; font-weight: bold; }\r\n    \")),\r\n    tags$script(src = \"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js\"),\r\n    tags$script(HTML(\"\r\n      window.pdfjsLib = window['pdfjs-dist/build/pdf'];\r\n      if (pdfjsLib) pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';\r\n    \")),\r\n    tags$script(HTML(\"(function(){async function readPdfFile(file){if(!file||!window.pdfjsLib)return;if(window.Shiny&&Shiny.setInputValue){Shiny.setInputValue('pdf_text_pages',null);}try{const buf=await file.arrayBuffer();const loadingTask=window.pdfjsLib.getDocument({data:new Uint8Array(buf)});const pdf=await loadingTask.promise;const pages=[];for(let p=1;p<=pdf.numPages;p++){const page=await pdf.getPage(p);const textContent=await page.getTextContent();const yTol=2;let lastY=-1;let lineBuffer=[];const pageLines=[];textContent.items.sort((a,b)=>{if(Math.abs(a.transform[5]-b.transform[5])>yTol){return b.transform[5]-a.transform[5];}return a.transform[4]-b.transform[4];});for(const item of textContent.items){if(lastY!==-1&&Math.abs(item.transform[5]-lastY)>yTol){pageLines.push(lineBuffer.join(' '));lineBuffer=[];}lineBuffer.push(item.str);lastY=item.transform[5];}if(lineBuffer.length>0){pageLines.push(lineBuffer.join(' '));}pages.push(pageLines.join('\\\\n'));}if(window.Shiny&&Shiny.setInputValue){Shiny.setInputValue('pdf_text_pages',pages,{priority:'event'});}}catch(err){console.error('Falha ao ler PDF via pdf.js:',err);if(window.Shiny&&Shiny.setInputValue){Shiny.setInputValue('pdf_text_pages_error',String(err),{priority:'event'});}}}document.addEventListener('change',e=>{const tgt=e.target;if(tgt&&tgt.id==='pdf_file'&&tgt.files&&tgt.files[0]){readPdfFile(tgt.files[0]);}},true);})();\")),\r\n    tags$script(HTML(\"function downloadData(data,filename,mime){const base64_string=data;const byteCharacters=atob(base64_string);const byteNumbers=new Array(byteCharacters.length);for(let i=0;i<byteCharacters.length;i++){byteNumbers[i]=byteCharacters.charCodeAt(i);}const byteArray=new Uint8Array(byteNumbers);const blob=new Blob([byteArray],{type:mime});const link=document.createElement('a');link.href=window.URL.createObjectURL(blob);link.download=filename;document.body.appendChild(link);link.click();document.body.removeChild(link);}Shiny.addCustomMessageHandler('download_b64',function(message){downloadData(message.data,message.filename,message.mime);});\"))\r\n  ),\r\n  div(\r\n    class = \"text-center p-4 mb-4\", style = \"background-color: #145A32; color: white;\",\r\n    h1(icon(\"file-invoice-dollar\"), \"Análise Automatizada de Pesquisa de Preços\"),\r\n    p(\"Faça o upload do seu relatório em PDF para extrair e analisar os dados das cotações.\", br(), \r\n      tags$small(\"Esta ferramenta está em conformidade com as diretrizes da Instrução Normativa SEGES/ME nº 65/2021.\", class = \"faded-text\")\r\n    )\r\n  ),\r\n  bslib::layout_sidebar(\r\n    sidebar = bslib::sidebar(\r\n      width = \"350px\",\r\n      bslib::card(\r\n        bslib::card_header(class = \"d-flex justify-content-between align-items-center\", \"Painel de Controle\", tags$span(icon(\"sliders-h\"), class = \"h5 mb-0\")),\r\n        bslib::card_body(\r\n          h5(\"1. Carregar Arquivo\"),\r\n          fileInput(\"pdf_file\", \"Selecione o relatório PDF:\", accept = c(\".pdf\"), width = \"100%\"),\r\n          h5(\"2. Processar e Baixar\"),\r\n          uiOutput(\"process_button_ui\")\r\n        ),\r\n        bslib::card_footer(\r\n          div(class = \"text-center small\", p(strong(\"Desenvolvimento:\")),\r\n              p(\"Marcos Castaneda\", br(), tags$small(\"Economista - Universidade Federal de Sergipe\")),\r\n              p(\"Roney Melo\", br(), tags$small(\"Atuário - Universidade Federal de Sergipe\"))\r\n          )\r\n        )\r\n      )\r\n    ),\r\n    bslib::layout_columns(\r\n      col_widths = c(6, 6),\r\n      bslib::card(\r\n        bslib::card_header(icon(\"book-open\"), \"Como Usar\"),\r\n        bslib::card_body(\r\n          p(\"Siga estes 3 passos simples para obter sua análise:\"),\r\n          tags$ol(\r\n            tags$li(strong(\"Carregue o arquivo:\"), \" Clique no botão 'Browse...' ou 'Navegar...' e escolha o PDF da pesquisa de preços (exclusivamente para arquivos PDF gerados no compras.gov).\"),\r\n            tags$li(strong(\"Inicie o processo:\"), \" Após o nome do arquivo aparecer, um botão verde surgirá. Clique em 'Processar e Baixar Excel'.\"),\r\n            tags$li(strong(\"Receba o resultado:\"), \" Aguarde a conclusão. O download da planilha Excel começará automaticamente.\")\r\n          )\r\n        )\r\n      ),\r\n      bslib::card(\r\n        height = \"100%\", bslib::card_header(icon(\"terminal\"), \"Status do Processamento\"),\r\n        bslib::card_body(style = \"background-color: #2E4053; color: #EAECEE; font-family: monospace; font-size: 0.9em; overflow-y: auto;\", verbatimTextOutput(\"status_text\"))\r\n      )\r\n    ),\r\n    br(),\r\n    div(\r\n      style = \"max-width: 100%;\", \r\n      bslib::card(\r\n        class = \"border-warning\",\r\n        bslib::card_body(\r\n          div(class = \"d-flex align-items-center\", div(icon(\"exclamation-triangle\", class = \"fa-2x text-warning me-3\")),\r\n              div(strong(\"Aviso Importante:\"), p(\"Esta ferramenta é um poderoso auxílio para a conferência da pesquisa de preços de referência feitas no compras.gov.br, mas não elimina a necessidade de avaliação crítica do responsável.\", class = \"mb-0 small\"))\r\n          )\r\n        )\r\n      )\r\n    )\r\n  )\r\n)\r\n\r\n# ===================================================================================\r\n# SERVIDOR (SERVER) - LÓGICA DA APLICAÇÃO\r\n# ===================================================================================\r\nserver <- function(input, output, session) {\r\n  \r\n  log_text <- reactiveVal(\"Aguardando o upload do arquivo PDF...\")\r\n  \r\n  observeEvent(input$pdf_file, {\r\n    req(input$pdf_file)\r\n    log_text(paste0(\"Arquivo '\", input$pdf_file$name, \"' carregado. Pronto para processar.\"))\r\n  })\r\n  \r\n  observeEvent(input$pdf_text_pages_error, ignoreInit = TRUE, {\r\n    log_text(paste(log_text(), \"\\n[AVISO] Falha do leitor PDF no navegador:\", input$pdf_text_pages_error))\r\n  })\r\n  \r\n  output$status_text <- renderText({ log_text() })\r\n  \r\n  output$process_button_ui <- renderUI({\r\n    req(input$pdf_file, input$pdf_text_pages)\r\n    actionButton(\"process_button\", \"Processar e Baixar Excel\", icon = icon(\"cogs\"), class = \"btn-primary btn-lg w-100\")\r\n  })\r\n  \r\n  observeEvent(input$process_button, {\r\n    req(input$pdf_file, input$pdf_text_pages)\r\n    \r\n    log_text(\"Iniciando o processo...\\nIsso pode levar alguns segundos.\\n\\n--- LOG DE PROCESSAMENTO ---\")\r\n    \r\n    withProgress(message = 'Processando...', value = 0, {\r\n      \r\n      tmp_xlsx_path <- NULL\r\n      \r\n      tryCatch({\r\n        setProgress(0.1, detail = \"Extraindo dados do PDF...\")\r\n        log_text(paste(log_text(), \"\\n[1/3] Extraindo dados...\"))\r\n        \r\n        text_pages <- get_pdf_text_pages(input$pdf_file$datapath, input$pdf_text_pages)\r\n        dados_extracao_pdf <- extract_price_data_from_pages(text_pages)\r\n        \r\n        if (nrow(dados_extracao_pdf) == 0) {\r\n          stop(\"Nenhum dado válido foi extraído do PDF. Verifique o formato do arquivo.\")\r\n        }\r\n        \r\n        setProgress(0.35, detail = \"Realizando cálculos...\")\r\n        log_text(paste(log_text(), \"\\n[2/3] Realizando cálculos...\"))\r\n        \r\n        all_pdf_medians <- extract_all_pdf_medians_from_pages(text_pages)\r\n        \r\n        extracao_df <- dados_extracao_pdf\r\n        extracao_df$`Preço unitário` <- parse_br_number(extracao_df$`Preço unitário`)\r\n        \r\n        base_data <- extracao_df %>%\r\n          filter(Compõe == \"Sim\" & !is.na(`Preço unitário`)) %>%\r\n          group_by(`Número da Pesquisa`, Item) %>%\r\n          arrange(`Nº Cotação`) %>%\r\n          mutate(price_num = paste0(\"PREÇO \", row_number())) %>%\r\n          summarise(\r\n            CATMAT = first(CATMAT), `Descrição do Item` = first(`Descrição do Item`),\r\n            prices_data = list(tibble::tibble(price_num, `Preço unitário`)), .groups = 'drop' \r\n          ) %>%\r\n          tidyr::unnest(prices_data) %>%\r\n          tidyr::pivot_wider(names_from = price_num, values_from = `Preço unitário`) %>%\r\n          ungroup()\r\n        \r\n        base_data$Item <- as.integer(base_data$Item)\r\n        all_pdf_medians$Item <- as.integer(all_pdf_medians$Item)\r\n        \r\n        dados_conferencia <- base_data %>%\r\n          left_join(all_pdf_medians, by = c(\"Número da Pesquisa\", \"Item\")) %>%\r\n          arrange(`Número da Pesquisa`, Item)\r\n        \r\n        price_cols <- grep(\"^PREÇO \\\\d+$\", names(dados_conferencia), value = TRUE)\r\n        if (length(price_cols) > 0) {\r\n          \r\n          final_col_order <- c(\r\n            \"Número da Pesquisa\", \"Item\", \"CATMAT\", \"Descrição do Item\", price_cols,\r\n            \"MÉDIA DOS PREÇOS\", \"MEDIANA DOS PREÇOS\", \"DESVIO PADRÃO DOS PREÇOS\",\r\n            \"COEFICIENTE DE VARIAÇÃO\", \"USAR MEDIANA?\", \"MEDIANA (PAINEL DE PREÇOS)\",\r\n            \"VALOR DE REFERÊNCIA\", \"Valor unitário de referência = ou < que a mediana do Compras?\"\r\n          )\r\n          \r\n          price_start_letter <- openxlsx::int2col(match(price_cols[1], final_col_order))\r\n          price_end_letter <- openxlsx::int2col(match(price_cols[length(price_cols)], final_col_order))\r\n          media_letter <- openxlsx::int2col(match(\"MÉDIA DOS PREÇOS\", final_col_order))\r\n          mediana_letter <- openxlsx::int2col(match(\"MEDIANA DOS PREÇOS\", final_col_order))\r\n          desvio_letter <- openxlsx::int2col(match(\"DESVIO PADRÃO DOS PREÇOS\", final_col_order))\r\n          cv_letter <- openxlsx::int2col(match(\"COEFICIENTE DE VARIAÇÃO\", final_col_order))\r\n          usar_mediana_letter <- openxlsx::int2col(match(\"USAR MEDIANA?\", final_col_order))\r\n          painel_letter <- openxlsx::int2col(match(\"MEDIANA (PAINEL DE PREÇOS)\", final_col_order))\r\n          ref_val_letter <- openxlsx::int2col(match(\"VALOR DE REFERÊNCIA\", final_col_order))\r\n          \r\n          dados_conferencia <- dados_conferencia %>%\r\n            mutate(\r\n              excel_row = row_number() + 2,\r\n              price_range = paste0(price_start_letter, excel_row, \":\", price_end_letter, excel_row),\r\n              `MÉDIA DOS PREÇOS` = paste0(\"AVERAGE(\", price_range, \")\"),\r\n              `MEDIANA DOS PREÇOS` = paste0(\"MEDIAN(\", price_range, \")\"),\r\n              `DESVIO PADRÃO DOS PREÇOS` = paste0(\"STDEVP(\", price_range, \")\"),\r\n              `COEFICIENTE DE VARIAÇÃO` = paste0(\"IFERROR(\", desvio_letter, excel_row, \"/\", media_letter, excel_row, \", 0)\"),\r\n              `USAR MEDIANA?` = paste0('IF(', cv_letter, excel_row, '>0.25, \"SIM\", \"NÃO\")'),\r\n              `VALOR DE REFERÊNCIA` = paste0('IF(', usar_mediana_letter, excel_row, '=\"SIM\", ', mediana_letter, excel_row, ', ', media_letter, excel_row, ')'),\r\n              `Valor unitário de referência = ou < que a mediana do Compras?` = paste0('IF(OR(ISBLANK(', ref_val_letter, excel_row, '), ISBLANK(', painel_letter, excel_row, ')), \"Verificar\", IF(', ref_val_letter, excel_row, '<=', painel_letter, excel_row, ', \"ATENDE\", \"NÃO ATENDE\"))')\r\n            )\r\n          \r\n          aba2_data <- dados_conferencia %>% select(any_of(final_col_order))\r\n        } else {\r\n          aba2_data <- dados_conferencia\r\n        }\r\n        \r\n        setProgress(0.80, detail = \"Montando arquivo Excel...\")\r\n        log_text(paste(log_text(), \"\\n[3/3] Montando o arquivo Excel...\"))\r\n        \r\n        ordem_desejada_aba1 <- c('Item', 'Compõe', 'Nº Cotação', 'Inciso', 'Nome', 'Quantidade', 'Unidade', 'Preço unitário', 'Data', 'Endereço Eletrônico', 'Anexo', 'Número da Pesquisa', 'UASG', 'Título da Pesquisa', 'CATMAT', 'Descrição do Item')\r\n        aba1_data <- dados_extracao_pdf %>% select(any_of(ordem_desejada_aba1))\r\n        \r\n        if (\"Endereço Eletrônico\" %in% names(aba1_data)) {\r\n          urls <- na_if(aba1_data$`Endereço Eletrônico`, \"\")\r\n          urls_cleaned <- str_extract(urls, \"https?://[^\\\\s]+\")\r\n          formulas_de_link <- ifelse(!is.na(urls_cleaned), paste0('=HYPERLINK(\"', urls_cleaned, '\",\"Link\")'), NA)\r\n          aba1_data$`Endereço Eletrônico` <- formulas_de_link\r\n          class(aba1_data$`Endereço Eletrônico`) <- \"formula\"\r\n        }\r\n        \r\n        formula_cols <- c(\"MÉDIA DOS PREÇOS\", \"MEDIANA DOS PREÇOS\", \"DESVIO PADRÃO DOS PREÇOS\", \"COEFICIENTE DE VARIAÇÃO\", \"USAR MEDIANA?\", \"VALOR DE REFERÊNCIA\", \"Valor unitário de referência = ou < que a mediana do Compras?\")\r\n        for(col in formula_cols) if (col %in% names(aba2_data)) class(aba2_data[[col]]) <- \"formula\"\r\n        \r\n        wb <- createWorkbook()\r\n        \r\n        # --- ABA 1: EXTRAÇÃO PDF ---\r\n        addWorksheet(wb, \"Extração_PDF\")\r\n        header_style_aba1 <- createStyle(textDecoration = \"bold\", fgFill = \"#1E8449\", fontColour = \"white\", halign = \"center\", valign = \"center\", border = \"TopBottomLeftRight\", wrapText = FALSE)\r\n        \r\n        writeData(wb, \"Extração_PDF\", aba1_data, headerStyle = header_style_aba1)\r\n        \r\n        setColWidths(wb, \"Extração_PDF\", cols = 1:ncol(aba1_data), widths = \"auto\")\r\n        if(\"Item\" %in% names(aba1_data)) setColWidths(wb, \"Extração_PDF\", cols = which(names(aba1_data) == \"Item\"), widths = 10)\r\n        if(\"Compõe\" %in% names(aba1_data)) setColWidths(wb, \"Extração_PDF\", cols = which(names(aba1_data) == \"Compõe\"), widths = 10)\r\n        if(\"Quantidade\" %in% names(aba1_data)) setColWidths(wb, \"Extração_PDF\", cols = which(names(aba1_data) == \"Quantidade\"), widths = 12)\r\n        if(\"UASG\" %in% names(aba1_data)) setColWidths(wb, \"Extração_PDF\", cols = which(names(aba1_data) == \"UASG\"), widths = 10)\r\n        if(\"CATMAT\" %in% names(aba1_data)) setColWidths(wb, \"Extração_PDF\", cols = which(names(aba1_data) == \"CATMAT\"), widths = 12)\r\n        if(\"Nome\" %in% names(aba1_data)) setColWidths(wb, \"Extração_PDF\", cols = which(names(aba1_data) == \"Nome\"), widths = 50)\r\n        if(\"Descrição do Item\" %in% names(aba1_data)) setColWidths(wb, \"Extração_PDF\", cols = which(names(aba1_data) == \"Descrição do Item\"), widths = 50)\r\n        \r\n        # --- ABA 2: CONFERÊNCIA ---\r\n        addWorksheet(wb, \"Conferência\")\r\n        \r\n        names(aba2_data)[names(aba2_data) == \"COEFICIENTE DE VARIAÇÃO\"] <- \"Coeficiente\\nde Variação\"\r\n        names(aba2_data)[names(aba2_data) == \"MEDIANA (PAINEL DE PREÇOS)\"] <- \"MEDIANA\\n(PAINEL DE PREÇOS)\"\r\n        names(aba2_data)[names(aba2_data) == \"Valor unitário de referência = ou < que a mediana do Compras?\"] <- \"Valor unitário de referência\\n= ou < que a mediana do Compras?\"\r\n        \r\n        regra_txt <- \"Regra: Usar média se CV<=25%\"\r\n        col_start_regra <- which(grepl(\"DESVIO PADRÃO\", names(aba2_data)))\r\n        col_end_regra <- which(grepl(\"USAR MEDIANA\", names(aba2_data)))\r\n        if(length(col_start_regra) > 0 && length(col_end_regra) > 0) {\r\n          writeData(wb, \"Conferência\", regra_txt, startCol = col_start_regra, startRow = 1)\r\n          mergeCells(wb, \"Conferência\", cols = col_start_regra:col_end_regra, rows = 1)\r\n          style_regra <- createStyle(halign = \"center\", textDecoration = \"bold\", fgFill = \"#FCE4D6\")\r\n          addStyle(wb, \"Conferência\", style = style_regra, rows = 1, cols = col_start_regra:col_end_regra, gridExpand = TRUE)\r\n        }\r\n        \r\n        header_style_aba2 <- createStyle(textDecoration = \"bold\", fgFill = \"#D9E1F2\", halign = \"center\", valign = \"center\", border = \"TopBottomLeftRight\", wrapText = TRUE)\r\n        writeData(wb, \"Conferência\", aba2_data, startRow = 2, headerStyle = header_style_aba2)\r\n        \r\n        currency_style <- createStyle(numFmt = \"R$ #,##0.0000\")\r\n        percent_style <- createStyle(numFmt = \"0.00%\")\r\n        currency_cols_names <- c(price_cols, \"MÉDIA DOS PREÇOS\", \"MEDIANA DOS PREÇOS\", \"DESVIO PADRÃO DOS PREÇOS\", \"VALOR DE REFERÊNCIA\", \"MEDIANA\\n(PAINEL DE PREÇOS)\")\r\n        percent_cols_names <- c(\"Coeficiente\\nde Variação\")\r\n        \r\n        setColWidths(wb, \"Conferência\", cols = 1:ncol(aba2_data), widths = \"auto\")\r\n        if(\"Item\" %in% names(aba2_data)) setColWidths(wb, \"Conferência\", cols = which(names(aba2_data) == \"Item\"), widths = 10)\r\n        if(\"CATMAT\" %in% names(aba2_data)) setColWidths(wb, \"Conferência\", cols = which(names(aba2_data) == \"CATMAT\"), widths = 12)\r\n        if(\"Descrição do Item\" %in% names(aba2_data)) setColWidths(wb, \"Conferência\", cols = which(names(aba2_data) == \"Descrição do Item\"), widths = 50)\r\n        for(col_name in names(aba2_data)){\r\n          col_idx <- which(names(aba2_data) == col_name)\r\n          style_to_apply <- NULL\r\n          if(col_name %in% currency_cols_names) {\r\n            style_to_apply <- currency_style\r\n            setColWidths(wb, \"Conferência\", cols = col_idx, widths = 18)\r\n          } else if (col_name %in% percent_cols_names) {\r\n            style_to_apply <- percent_style\r\n          }\r\n          if(!is.null(style_to_apply)) addStyle(wb, \"Conferência\", style = style_to_apply, rows = 3:(nrow(aba2_data) + 2), cols = col_idx, gridExpand = TRUE, stack = TRUE)\r\n        }\r\n        \r\n        tmp_xlsx_path <- tempfile(fileext = \".xlsx\")\r\n        saveWorkbook(wb, tmp_xlsx_path, overwrite = TRUE)\r\n        \r\n        setProgress(0.9, detail = \"Iniciando download...\")\r\n        filename <- paste0(\"Análise_Pesquisa_\", tools::file_path_sans_ext(input$pdf_file$name), format(Sys.time(), \"_%d-%m-%Y_%Hh%Mm%Ss\"), \".xlsx\")\r\n        file_data <- readBin(tmp_xlsx_path, \"raw\", file.info(tmp_xlsx_path)$size)\r\n        encoded_data <- base64enc::base64encode(file_data)\r\n        \r\n        session$sendCustomMessage(type = \"download_b64\", message = list(data = encoded_data, filename = filename, mime = \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\"))\r\n        \r\n        setProgress(1, detail = \"Concluído!\")\r\n        log_text(paste(log_text(), \"\\n\\n--- SUCESSO! ---\\nO arquivo Excel foi gerado. O download deve iniciar automaticamente.\"))\r\n        \r\n      }, error = function(e) {\r\n        log_text(paste(\"ERRO DURANTE O PROCESSAMENTO:\\n\\n\", e$message))\r\n      }, finally = {\r\n        if (!is.null(tmp_xlsx_path) && file.exists(tmp_xlsx_path)) unlink(tmp_xlsx_path)\r\n      })\r\n    }) \r\n  })\r\n}\r\n\r\n# ===================================================================================\r\n# INICIA A APLICAÇÃO SHINY\r\n# ===================================================================================\r\nshinyApp(ui, server)","type":"text"},{"name":"importa_shinylive.R","content":"install.packages(\"shinylive\")\r\ninstall.packages(\"httpuv\")\r\n\r\n\r\nlibrary(shinylive)\r\nlibrary(httpuv)\r\n\r\n\r\nshinylive::export(appdir = \".\", destdir = \"docs\")\r\n\r\nhttpuv::runStaticServer(\"docs/\", port = 8008)\r\n\r\n\r\n","type":"text"}]
